# Сервис анализа и маркировки данных

Комплексный веб-сервис для анализа сегментированных данных электрического тока и предоставления интерактивных возможностей маркировки для наборов данных машинного обучения.

## Возможности

### Загрузка данных
- **Поддержка HDF5**: Загрузка сегментированных данных из файлов HDF5
- **Поддержка множественных файлов**: Обработка нескольких файлов данных одновременно
- **Управление сегментами**: Эффективная навигация по сегментам данных

### Спектральный анализ
- **Быстрое преобразование Фурье (БПФ)**: Анализ в частотной области
- **Кратковременное преобразование Фурье (КПФ)**: Анализ во временно-частотной области
- **Анализ огибающей**: Обнаружение дефектов подшипников
- **Вейвлет-анализ**: Обработка нестационарных сигналов
- **Обнаружение пиков**: Автоматическое определение спектральных пиков
- **Статистические характеристики**: Комплексное извлечение признаков

### Интерактивная визуализация
- **Графики временных рядов**: Визуализация исходного сигнала
- **Спектры БПФ**: Визуализация в частотной области
- **Спектрограммы**: Тепловые карты времени-частоты
- **Анализ огибающей**: Индикаторы дефектов подшипников
- **Вейвлет-анализ**: Визуализация многоуровневого анализа
- **Комплексная панель**: Все анализы в одном представлении

### Интерфейс маркировки
- **Категории дефектов**:
  - Нормальный
  - Дефект наружного кольца
  - Дефект внутреннего кольца
  - Дефект тел качения
  - Дефект сепаратора
  - Дисбаланс
  - Несоосность
  - Другое

- **Уровни серьезности**:
  - Начальный
  - Средний
  - Высокий
  - Критический

- **Дополнительные возможности**:
  - Оценка уверенности (0-1)
  - Атрибуция аналитика
  - Комментарии и заметки
  - Отслеживание временных меток

### Управление данными
- **Хранение HDF5**: Эффективное хранение меток
- **Экспорт CSV**: Простой экспорт данных
- **Отслеживание прогресса**: Отслеживание прогресса маркировки в реальном времени
- **Панель статистики**: Анализ распределения меток
- **Поддержка резервных копий**: Автоматическое создание резервных копий

## Установка

### Предварительные требования
- Python 3.9+ или Anaconda/Miniconda
- Docker (опционально)

### Вариант 1: Установка Anaconda (рекомендуется)

1. **Клонируйте репозиторий**:
```bash
git clone <repository-url>
cd data_analysis_labeling_service
```

2. **Настройте окружение Anaconda**:
```bash
./setup_conda_env.sh
```

3. **Запустите приложение**:
```bash
./start_conda.sh
```

4. **Откройте веб-интерфейс**:
Откройте браузер и перейдите по адресу `http://localhost:8050`

### Вариант 2: Стандартная установка Python

1. **Клонируйте репозиторий**:
```bash
git clone <repository-url>
cd data_analysis_labeling_service
```

2. **Установите зависимости**:
```bash
pip install -r requirements.txt
```

3. **Запустите приложение**:
```bash
python main.py
```

4. **Откройте веб-интерфейс**:
Откройте браузер и перейдите по адресу `http://localhost:8050`

### Вариант 3: Установка Docker

1. **Соберите и запустите с Docker Compose**:
```bash
docker-compose up --build
```

2. **Или соберите и запустите вручную**:
```bash
docker build -t data-analysis-labeling-service .
docker run -p 8050:8050 -v $(pwd)/app/data:/app/app/data data-analysis-labeling-service
```

## Управление окружением Anaconda

### Создание окружения
```bash
./setup_conda_env.sh
```

### Запуск приложения
```bash
./start_conda.sh
```

### Обновление окружения
```bash
./update_conda_env.sh
```

### Ручное управление окружением
```bash
# Создание окружения
conda env create -f environment.yml

# Активация окружения
conda activate data-analysis-labeling

# Обновление окружения
conda env update -f environment.yml

# Удаление окружения (при необходимости)
conda env remove -n data-analysis-labeling
```

## Использование

### Начало работы

1. **Выберите файл данных**: Выберите файл HDF5 из выпадающего меню
2. **Загрузите сегменты**: Приложение автоматически загрузит доступные сегменты
3. **Навигация по сегментам**: Используйте кнопки Предыдущий/Следующий или выберите из выпадающего списка
4. **Анализ данных**: Нажмите "Анализировать сегмент" для выполнения спектрального анализа
5. **Просмотр визуализаций**: Изучите различные представления анализа во вкладках
6. **Применение меток**: Используйте интерфейс маркировки для категоризации дефектов
7. **Сохранение меток**: Нажмите "Сохранить метку" для хранения ваших аннотаций
8. **Экспорт данных**: Используйте "Экспорт меток" для загрузки CSV-файла

### Формат данных

Сервис ожидает файлы HDF5 со следующей структурой:
```
segments/
├── phase_current_T/
│   ├── current_T_000990/
│   │   └── data: [1024,] float64
│   ├── current_T_000991/
│   │   └── data: [1024,] float64
│   └── ...
```

### Параметры анализа

- **Частота дискретизации**: По умолчанию 1000 Гц (настраивается)
- **Окно БПФ**: Окно Ханна (настраивается)
- **Параметры КПФ**: 256-точечные сегменты, 128-точечное перекрытие
- **Анализ огибающей**: 0.1 * частота Найквиста
- **Вейвлет-анализ**: Вейвлет Добеши 4, логарифмические масштабы

## Конфигурация

### Переменные окружения
- `PYTHONUNBUFFERED=1`: Включить небуферизованный вывод
- `DASH_DEBUG=False`: Отключить режим отладки для продакшена
- `SAMPLE_RATE=1000`: Установить частоту дискретизации по умолчанию

### Пути к файлам
- Файлы данных: `app/data/`
- Хранение меток: `app/data/labeled_data.h5`
- Файлы экспорта: `app/data/labels_export.csv`
- Логи: `app.log`

## Справочник API

### DataLoader
```python
from app.data_loader import DataLoader

# Инициализация загрузчика
loader = DataLoader("path/to/data.h5")

# Получение данных сегмента
data = loader.get_segment_data("current_T_000990")

# Получение информации о сегменте
info = loader.get_segment_info("current_T_000990")
```

### SpectralAnalyzer
```python
from app.spectral_analysis import SpectralAnalyzer

# Инициализация анализатора
analyzer = SpectralAnalyzer(sample_rate=1000.0)

# Выполнение анализа
results = analyzer.analyze_segment(data)
```

### LabelManager
```python
from app.label_manager import LabelManager

# Инициализация менеджера
manager = LabelManager("labels.h5")

# Добавление метки
manager.add_label(
    segment_id="current_T_000990",
    defect_category="Дефект наружного кольца",
    severity="Средний",
    confidence=0.8,
    analyst="Иван Иванов",
    comments="Четкая сигнатура дефекта подшипника"
)
```

## Устранение неполадок

### Частые проблемы

1. **Файл HDF5 не найден**:
   - Убедитесь, что файлы данных находятся в директории `app/data/`
   - Проверьте права доступа к файлам

2. **Проблемы с памятью**:
   - Большие файлы могут требовать больше памяти
   - Рассмотрите обработку меньшими пакетами

3. **Порт уже используется**:
   - Измените порт в `main.py` или конфигурации Docker
   - Завершите существующие процессы на порту 8050

4. **Отсутствуют зависимости**:
   - Переустановите требования: `pip install -r requirements.txt`
   - Проверьте совместимость версии Python

### Логи
Проверьте `app.log` для подробных сообщений об ошибках и отладочной информации.

## Разработка

### Структура проекта
```
data_analysis_labeling_service/
├── app/
│   ├── __init__.py
│   ├── data_loader.py          # Загрузка данных HDF5
│   ├── spectral_analysis.py    # Обработка сигналов
│   ├── label_manager.py        # Управление метками
│   ├── visualization.py        # Визуализации Plotly
│   ├── dash_app.py            # Основное веб-приложение
│   └── data/                  # Файлы данных
├── main.py                    # Точка входа
├── requirements.txt           # Зависимости
├── Dockerfile                 # Конфигурация контейнера
├── docker-compose.yml         # Оркестрация Docker
└── README.md                  # Этот файл
```

### Добавление новых возможностей

1. **Новые методы анализа**: Расширьте класс `SpectralAnalyzer`
2. **Новые визуализации**: Добавьте методы в класс `SpectralVisualizer`
3. **Новые категории меток**: Обновите `LabelManager.DEFECT_CATEGORIES`
4. **Компоненты UI**: Измените макет и обратные вызовы в `dash_app.py`

### Тестирование
```bash
# Запуск базового теста функциональности
python -c "from app.data_loader import DataLoader; print('DataLoader успешно импортирован')"
```

## Лицензия

Этот проект лицензирован под лицензией MIT - см. файл LICENSE для подробностей.

## Вклад в проект

1. Форкните репозиторий
2. Создайте ветку функций
3. Внесите изменения
4. Добавьте тесты, если применимо
5. Отправьте pull request

## Поддержка

Для проблем и вопросов:
- Проверьте раздел устранения неполадок
- Просмотрите логи
- Создайте issue в репозитории
- Свяжитесь с командой разработки
